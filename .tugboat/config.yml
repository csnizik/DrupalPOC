services:
  webserver:
    image: tugboatqa/php:8.3-apache
    default: true
    depends: database
    commands:
      init:
        # Install opcache and mod-rewrite
        - docker-php-ext-install opcache
        - a2enmod headers rewrite
        # Link the document root to the expected path.
        - ln -snf "${TUGBOAT_ROOT}/web" "${DOCROOT}"
        # Link the config directory.
        - ln -snf "${TUGBOAT_ROOT}/config" "${DOCROOT}/../config"

      update:
        - composer self-update
        - composer install --optimize-autoloader
        - cp .tugboat/tugboat.settings.php $TUGBOAT_ROOT/web/sites/default/settings.local.php

        - |
          if [ -f "${TUGBOAT_ROOT}/files.tgz" ]; then
            rm -rf "${DOCROOT}/sites/default/files"
            tar -xvzf files.tgz
            mv files "${DOCROOT}/sites/default"
          else
            mkdir "${DOCROOT}/sites/default/files"
          fi

        - chgrp -R www-data "${DOCROOT}/sites/default/files"
        - find "${DOCROOT}/sites/default/files" -type d -exec chmod 2775 {} \;
        - find "${DOCROOT}/sites/default/files" -type f -exec chmod 0664 {} \;

      build:
        - composer install --optimize-autoloader
        - composer require drush/drush
        - vendor/bin/drush cache:rebuild
        - vendor/bin/drush config:import -y
        - vendor/bin/drush updatedb -y
        - vendor/bin/drush cache:rebuild

      start:
        # Warm the homepage
        - 'curl --silent -H "Host: TUGBOAT_DEFAULT_SERVICE_URL_HOST" http://localhost > /dev/null'



  database:
    image: tugboatqa/mariadb:10.11
    checkout: true # Need this line for a service to have access to repo
    commands:
      init:
        - echo "init"
        - mysql -e "SET GLOBAL max_allowed_packet=536870912;"
        - echo "max_allowed_packet=536870912" >> /etc/mysql/conf.d/tugboat.cnf
        - mysql -e 'DROP DATABASE tugboat; CREATE DATABASE tugboat;'
        - if [ -f "${TUGBOAT_ROOT}"/data/db.sql ]; then cp "${TUGBOAT_ROOT}/data/db.sql" /tmp/; else echo "Database file not found"; ls -alh; fi
      start:

